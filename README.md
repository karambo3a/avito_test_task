# Avito Test Task

### Описание сервиса

Сервис управления код-ревью для Pull Request'ов. Основные возможности:

* Назначение ревьюеров на PR из команды автора
* Переназначение ревьюверов до момента мержа PR
* Просмотр PR'ов, назначенных конкретному пользователю
* Управление командами и активностью пользователей
* Запрет изменений состава ревьюверов после мержа PR

Особенности:
* **Идемпотентность мержа** - повторный вызов merge возвращает актуальное состояние PR
* **Ограничение ревьюверов** - максимум 2 ревьювера на PR
* **Проверка активности** - только активные пользователи назначаются на ревью
* **Блокировка изменений** - после мержа состав ревьюверов неизменяем

### Пререквизиты

Перед запуском сервиса и тестов необходимо установить переменные окружения. Пример описан в файле `.env.example`.

### Запуск и тестирование

1. **Запуск сервиса**

    ```bash
    make up
    ```

    Сервис будет доступен на порту **8080**.

2. **Остановка сервиса**

    Остановить сервис можно командой:
    ```bash
    make down
    ```

3. **Запуск тестов**

    ```bash
    make test
    ```

4. **Линтер**

    ```bash
    make lint
    ```
В Makefile используется команда `docker compose`. Eсли будет ошибка, попробуйте использовать `docker-compose`.

### Архитектура

Сервис состоит из двух основных компонентов:

1. PostgreSQL 16 - база данных
2. Go сервис - основное приложение

### Файлы конфигурации

1. `compose.yaml` - основной docker-compose файл
2. `test/compose.integration.yaml` - конфигурация для интеграционных тестов
3. `Dockerfile` - сборка Go приложения
4. `.env.example` - пример файла `.env`

### Описание endpoints

1. `POST /team/add`

    * Создает новую команду с указанными участниками
    * Возвращает созданную команду
    * Ошибки: команда уже существует, пустые входные поля, внутренняя ошибка сервера

    Допущения:
    * При попытке создать команду без участников (пустой массив Members), то возращается ошибка с кодом `EMPTY_FIELD`, потому что непонятно зачем создавать пустые команды

2. `GET /team/get`

    * Получает информацию о команде по её названию
    * Возвращает имя команды и список участников
    * Ошибки: команда не найдена, пустые входные поля, внутренняя ошибка сервера

3. `POST /users/setIsActive`

    * Получает список всех PR, назначенных на ревью пользователю
    * Возвращает массив pull request'ов
    * Ошибки: пользователь не найден, пустые входные поля, внутренняя ошибка сервера

4. `GET /users/getReview`

    * Получает список всех PR, назначенных на ревью пользователю
    * Возвращает массив pull request'ов
    * Ошибки: пользователь не найден, пустые входные поля, внутренняя ошибка сервера

    Допущения:
    * При попытке получить список Pull Request'ов для несуществудющего пользователя возвращается ошибка с кодом `NOT_FOUND`, потому что это правильнее, чем вернуть просто пустой массив.

5. `POST /pullRequest/create`

    * Создает новый pull request и автоматически назначает ревьюверов из команды автора
    * Возвращает созданный PR с назначенными ревьюверами
    * Ошибки: автор не найден, PR уже существует, пустые входные поля, внутренняя ошибка сервера

6. `POST /pullRequest/merge`

    * Выполняет мерж pull request'а и блокирует дальнейшие изменения
    * Возвращает обновленный PR с временем мержа
    * Ошибки: PR не найден, пустые входные поля, внутренняя ошибка сервера

7. `POST /pullRequest/reassign`

    * Заменяет одного ревьювера на другого активного участника из команды
    * Возвращает обновленный PR и информацию о новом ревьювере
    * Ошибки: PR не найден, пользователь не назначен на ревью, PR уже замержен, нет активных кандидатов для замены, пустые входные поля, внутренняя ошибка сервера

**Дополнительное задание**

8. `GET /statistics/user`

    * Получает статистику по пользователю (количество PR, ревью и т.д.)
    * Возвращает детальную статистику активности
    * О*шибки: пользователь не найден, пустые поля, внутренняя ошибка сервера

9. `GET /statistics/team`

    * Получает статистику по команде (активность, распределение ревью и т.д.)
    * Возвращает агрегированную статистику команды
    * Ошибки: команда не найдена, пустые поля, внутренняя ошибка сервера

Был добавлен новый код ошибки `EMPTY_FIELD`, помимо имеющихся в `openapi.yml`, чтобы обрабатывать случаи, когда на вход хэндлерам подаются пустые значения.

Все эндпоинты возвращают стандартизированные HTTP статусы:

* **200 OK**
* **200 Created** - ресурс успешно создан (команда, PR)
* **400 Bad Request** - пустые или некорректные поля
* **404 Not Found** - сущность не найдена (пользователь, команда, PR)
* **409 Conflict** - бизнес-логика нарушена (PR уже существует, уже замержен, нет кандидатов)
* **500 Internal Server Error** - внутренние ошибки сервера

### Схема базы данных

#### **Таблица `team`**
Хранит информацию о командах.

*`team_name` - уникальное название команды

---

#### **Таблица `users`**
Хранит информацию о пользователях и их принадлежности к командам.

* `user_id` - уникальный идентификатор пользователя
* `username` - имя пользователя
* `team_name` - название команды пользователя
* `is_active` - флаг активности пользователя

**Индексы:**
* `is_active_team_idx` - для поиска активных пользователей по команде
* `is_active_user_idx` - для проверки активности пользователя

---

#### **Таблица `pr`**
Хранит информацию о Pull Requests.

* `pr_id` - уникальный идентификатор PR
* `pr_name` - название Pull Request'а
* `author_id` - автор PR
* `status` - статус: `OPEN` или `MERGED`
* `created_at` - время создания
* `merged_at` - время мержа (если применен)

**Индексы:**
* `pr_author_id_idx` - для поиска PR по автору
* `pr_status_idx` - для фильтрации по статусу

---

#### **Таблица `reviewer_x_pr`**
Связующая таблица между ревьюверами и PR.

* `user_id` - идентификатор ревьювера
* `pr_id` - идентификатор PR

**Индексы:**
* `reviewer_x_pr_pr_id_idx` - для поиска ревьюверов по PR

### Нагрузочное тестирование

Было проведено нагрузочное тестирование при помощи `Postman`.

Описание теста:

* **Iterations**: 150
* **Delay**: 200ms

По результатам теста было получено:
* SLI времени ответа - 2.82ms
* SLI успешности — 100.0%
